name: ì´ìŠˆ ì¢…ë£Œ ì‹œ Jira ìƒíƒœ ì „í™˜ ë° ì‘ì—… ì¤‘ ë¼ë²¨ ì œê±°

on:
  issues:
    types: [closed]

jobs:
  sync-close:
    name: Jira ìƒíƒœ ì™„ë£Œ ì²˜ë¦¬ ë° ë¼ë²¨ ì œê±°
    runs-on: ubuntu-latest

    steps:
      - name: Jira ë¡œê·¸ì¸
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}

      - name: ì´ìŠˆ ì œëª©ì—ì„œ Jira í‚¤ ì¶”ì¶œ
        id: extract
        run: |
          TITLE="${{ github.event.issue.title }}"
          JIRA_KEY=$(echo "$TITLE" | grep -oE '\[[A-Z]+-[0-9]+\]' | head -n1 | tr -d '[]')

          if [ -n "$JIRA_KEY" ]; then
            echo "âœ… Jira í‚¤: $JIRA_KEY"
            echo "jira_key=$JIRA_KEY" >> $GITHUB_OUTPUT
          else
            echo "âŒ Jira í‚¤ë¥¼ ì´ìŠˆ ì œëª©ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

      - name: Jira íƒœìŠ¤í¬ ìƒíƒœë¥¼ ì™„ë£Œë¡œ ë³€ê²½
        uses: atlassian/gajira-transition@v3
        with:
          issue: ${{ steps.extract.outputs.jira_key }}
          transition: ì™„ë£Œ

      - name: GitHub ì´ìŠˆì—ì„œ "ğŸ›  ì‘ì—… ì¤‘" ë¼ë²¨ ì œê±°
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'remove-labels'
          token: ${{ secrets.PERSONAL_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          labels: 'ğŸ›  ì‘ì—… ì¤‘'
